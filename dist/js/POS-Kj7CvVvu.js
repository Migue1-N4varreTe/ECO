var e=Object.defineProperty,s=Object.defineProperties,a=Object.getOwnPropertyDescriptors,t=Object.getOwnPropertySymbols,l=Object.prototype.hasOwnProperty,r=Object.prototype.propertyIsEnumerable,n=(s,a,t)=>a in s?e(s,a,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[a]=t,i=(e,s)=>{for(var a in s||(s={}))l.call(s,a)&&n(e,a,s[a]);if(t)for(var a of t(s))r.call(s,a)&&n(e,a,s[a]);return e},c=(e,t)=>s(e,a(t)),o=(e,s,a)=>new Promise((t,l)=>{var r=e=>{try{i(a.next(e))}catch(s){l(s)}},n=e=>{try{i(a.throw(e))}catch(s){l(s)}},i=e=>e.done?t(e.value):Promise.resolve(e.value).then(r,n);i((a=a.apply(e,s)).next())});import{j as d,a7 as m,aA as x,aB as u,aC as h,aF as p,bs as j,aV as f,bt as v,a_ as N,ac as g,bu as y,aP as b,as as w,aa as C,aL as k,aH as S}from"./chunk-D1ivKm1I.js";import{a as E}from"./chunk-CNNdbZTC.js";import{C as P,n as F,o as _,B as I,e as O,b as z,p as D,L as M,I as T,D as $,r as B,t as A,v as q}from"./index-17eEFbcJ.js";import{S as R}from"./chunk-BZj8Mp6R.js";import{T as U,a as L,b as V,c as K}from"./chunk-BDIyvL0l.js";import{T as X}from"./chunk-DtJU0gqK.js";import"./chunk-DGERTDnL.js";import"./chunk-BdChqvju.js";import"./chunk-B5XYL1Sr.js";const J=({items:e,summary:s,onUpdateQuantity:a,onRemoveItem:t,onClearCart:l,onCheckout:r})=>{const n=e=>new Intl.NumberFormat("es-MX",{style:"currency",currency:"MXN"}).format(e);return d.jsxs(P,{className:"h-full flex flex-col",children:[d.jsx(F,{className:"pb-3",children:d.jsxs("div",{className:"flex items-center justify-between",children:[d.jsxs(_,{className:"flex items-center gap-2",children:[d.jsx(m,{className:"w-5 h-5"}),"Carrito (",s.total_items,")"]}),e.length>0&&d.jsx(I,{variant:"ghost",size:"sm",onClick:l,className:"text-red-600 hover:text-red-700",children:d.jsx(x,{className:"w-4 h-4"})})]})}),d.jsxs(O,{className:"flex-1 flex flex-col p-0",children:[d.jsx("div",{className:"flex-1 overflow-y-auto px-6",children:0===e.length?d.jsxs("div",{className:"text-center py-8",children:[d.jsx(m,{className:"mx-auto h-12 w-12 text-gray-400"}),d.jsx("h3",{className:"mt-2 text-sm font-semibold text-gray-900",children:"Carrito vacío"}),d.jsx("p",{className:"mt-1 text-sm text-gray-500",children:"Agrega productos para comenzar"})]}):d.jsx("div",{className:"space-y-3",children:e.map(e=>d.jsxs("div",{className:"border rounded-lg p-3",children:[d.jsxs("div",{className:"flex justify-between items-start mb-2",children:[d.jsxs("div",{className:"min-w-0 flex-1",children:[d.jsx("h4",{className:"font-medium text-sm leading-tight",children:e.products.name}),e.products.sku&&d.jsxs("p",{className:"text-xs text-muted-foreground",children:["SKU: ",e.products.sku]}),d.jsxs("div",{className:"text-sm font-semibold mt-1",children:[n(e.unit_price)," / ",e.products.unit]})]}),d.jsx(I,{variant:"ghost",size:"sm",onClick:()=>t(e.id),className:"text-red-600 hover:text-red-700 ml-2",children:d.jsx(x,{className:"w-3 h-3"})})]}),d.jsxs("div",{className:"flex items-center justify-between",children:[d.jsxs("div",{className:"flex items-center gap-1",children:[d.jsx(I,{variant:"outline",size:"sm",onClick:()=>a(e.id,e.quantity-1),disabled:e.quantity<=1,className:"h-7 w-7 p-0",children:d.jsx(u,{className:"w-3 h-3"})}),d.jsx("span",{className:"w-8 text-center text-sm font-medium",children:e.quantity}),d.jsx(I,{variant:"outline",size:"sm",onClick:()=>a(e.id,e.quantity+1),disabled:e.quantity>=e.products.stock_quantity,className:"h-7 w-7 p-0",children:d.jsx(h,{className:"w-3 h-3"})})]}),d.jsxs("div",{className:"text-right",children:[d.jsx("div",{className:"font-semibold",children:n(e.subtotal)}),e.quantity>=e.products.stock_quantity&&d.jsx(z,{variant:"destructive",className:"text-xs mt-1",children:"Stock máximo"})]})]})]},e.id))})}),e.length>0&&d.jsxs("div",{className:"border-t bg-gray-50 p-6 space-y-3",children:[d.jsxs("div",{className:"space-y-2",children:[d.jsxs("div",{className:"flex justify-between text-sm",children:[d.jsx("span",{children:"Subtotal:"}),d.jsx("span",{children:n(s.subtotal)})]}),s.tax>0&&d.jsxs("div",{className:"flex justify-between text-sm",children:[d.jsx("span",{children:"IVA:"}),d.jsx("span",{children:n(s.tax)})]}),d.jsx(R,{}),d.jsxs("div",{className:"flex justify-between font-bold text-lg",children:[d.jsx("span",{children:"Total:"}),d.jsx("span",{children:n(s.total)})]})]}),d.jsxs(I,{onClick:r,className:"w-full h-12 text-lg",size:"lg",children:[d.jsx(p,{className:"w-5 h-5 mr-2"}),"Procesar Pago (F3)"]})]})]})]})},H=({onScan:e,onClose:s,loading:a=!1})=>{const[t,l]=E.useState(""),[r,n]=E.useState(!1),[i,c]=E.useState(""),m=E.useRef(null),x=E.useRef(null),u=E.useRef(null),{toast:h}=D();E.useEffect(()=>(u.current&&u.current.focus(),()=>{p()}),[]);const p=()=>{x.current&&(x.current.getTracks().forEach(e=>e.stop()),x.current=null),n(!1)},N=()=>{const s=["7501234567890","7502345678901","7503456789012","123456789012"],a=s[Math.floor(Math.random()*s.length)];e(a)};return d.jsxs("div",{className:"space-y-4",onKeyDown:e=>{"Escape"===e.key&&s()},children:[d.jsxs(U,{defaultValue:"manual",className:"w-full",children:[d.jsxs(L,{className:"grid w-full grid-cols-2",children:[d.jsxs(V,{value:"manual",className:"flex items-center gap-2",children:[d.jsx(j,{className:"w-4 h-4"}),"Manual"]}),d.jsxs(V,{value:"camera",className:"flex items-center gap-2",children:[d.jsx(f,{className:"w-4 h-4"}),"Cámara"]})]}),d.jsxs(K,{value:"manual",className:"space-y-4",children:[d.jsx(P,{children:d.jsx(O,{className:"pt-6",children:d.jsxs("form",{onSubmit:s=>{s.preventDefault(),t.trim()&&(e(t.trim()),l(""))},className:"space-y-4",children:[d.jsxs("div",{className:"space-y-2",children:[d.jsx(M,{htmlFor:"manual-code",children:"Código de Barras"}),d.jsx(T,{id:"manual-code",ref:u,value:t,onChange:e=>l(e.target.value),placeholder:"Ingresa el código manualmente...",className:"text-lg",disabled:a,autoComplete:"off"})]}),d.jsxs("div",{className:"flex gap-2",children:[d.jsxs(I,{type:"submit",disabled:!t.trim()||a,className:"flex-1",children:[a?d.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-white mr-2"}):d.jsx(v,{className:"w-4 h-4 mr-2"}),"Buscar Producto"]}),d.jsx(I,{type:"button",variant:"outline",onClick:s,children:"Cancelar"})]})]})})}),d.jsx(P,{className:"border-dashed",children:d.jsx(O,{className:"pt-6",children:d.jsxs("div",{className:"text-center space-y-2",children:[d.jsx("p",{className:"text-sm text-muted-foreground",children:"Modo de prueba"}),d.jsx(I,{variant:"outline",onClick:N,className:"w-full",children:"Simular Escaneo"})]})})})]}),d.jsx(K,{value:"camera",className:"space-y-4",children:d.jsx(P,{children:d.jsx(O,{className:"pt-6",children:r?d.jsxs("div",{className:"space-y-4",children:[d.jsxs("div",{className:"relative",children:[d.jsx("video",{ref:m,className:"w-full h-64 bg-black rounded-lg object-cover",autoPlay:!0,muted:!0,playsInline:!0}),d.jsx("div",{className:"absolute inset-0 flex items-center justify-center",children:d.jsx("div",{className:"w-48 h-32 border-2 border-white border-dashed rounded-lg flex items-center justify-center",children:d.jsx(v,{className:"w-8 h-8 text-white animate-pulse"})})})]}),d.jsxs("div",{className:"text-center space-y-2",children:[d.jsx("p",{className:"text-sm text-muted-foreground",children:"Coloca el código de barras dentro del recuadro"}),d.jsxs("div",{className:"flex gap-2",children:[d.jsx(I,{variant:"outline",onClick:p,className:"flex-1",children:"Detener Cámara"}),d.jsx(I,{variant:"outline",onClick:N,children:"Simular"})]})]})]}):d.jsxs("div",{className:"text-center space-y-4",children:[d.jsx("div",{className:"w-32 h-32 mx-auto bg-gray-100 rounded-lg flex items-center justify-center",children:d.jsx(f,{className:"w-12 h-12 text-gray-400"})}),d.jsxs("div",{children:[d.jsx("h3",{className:"font-semibold",children:"Escáner de cámara"}),d.jsx("p",{className:"text-sm text-muted-foreground",children:"Usa la cámara para escanear códigos de barras"})]}),i&&d.jsx("div",{className:"text-sm text-red-600 bg-red-50 p-3 rounded-md",children:i}),d.jsxs("div",{className:"flex gap-2",children:[d.jsxs(I,{onClick:()=>o(null,null,function*(){try{if(c(""),n(!0),!navigator.mediaDevices||!navigator.mediaDevices.getUserMedia)throw new Error("El navegador no soporta acceso a la cámara");const e=yield navigator.mediaDevices.getUserMedia({video:{facingMode:"environment",width:{ideal:1280},height:{ideal:720}}});x.current=e,m.current&&(m.current.srcObject=e,m.current.play()),h({title:"Cámara activada",description:"Enfoca el código de barras en la cámara"})}catch(e){c("No se pudo acceder a la cámara. Usa la entrada manual."),n(!1)}}),className:"flex-1",children:[d.jsx(f,{className:"w-4 h-4 mr-2"}),"Activar Cámara"]}),d.jsx(I,{variant:"outline",onClick:s,children:"Cancelar"})]})]})})})})]}),d.jsx("div",{className:"text-xs text-muted-foreground text-center",children:"Presiona Esc para cerrar"})]})},Q=({cartItems:e,cartSummary:s,selectedClient:a,onPaymentComplete:t,onCancel:l})=>{const[r,n]=E.useState("efectivo"),[i,c]=E.useState(""),[m,x]=E.useState("0"),[u,h]=E.useState(""),[j,f]=E.useState(""),[v,w]=E.useState(!1),[C,k]=E.useState(0),[S,z]=E.useState(s.total),{toast:$}=D();E.useEffect(()=>{const e=parseFloat(m)||0,a=Math.max(0,s.total-e);z(a);const t=parseFloat(i)||0;k(Math.max(0,t-a))},[m,i,s.total]),E.useEffect(()=>{"efectivo"!==r||i||c(S.toString())},[r,S]);const B=e=>new Intl.NumberFormat("es-MX",{style:"currency",currency:"MXN"}).format(e),A=[{value:"efectivo",label:"Efectivo",icon:y},{value:"tarjeta",label:"Tarjeta",icon:p},{value:"transferencia",label:"Transferencia",icon:b}],q=[S,10*Math.ceil(S/10),50*Math.ceil(S/50),100*Math.ceil(S/100)].filter((e,s,a)=>a.indexOf(e)===s);return d.jsxs("div",{className:"space-y-6 max-w-2xl",children:[d.jsxs(P,{children:[d.jsx(F,{children:d.jsxs(_,{className:"flex items-center gap-2",children:[d.jsx(N,{className:"w-5 h-5"}),"Resumen de Venta"]})}),d.jsxs(O,{className:"space-y-4",children:[a&&d.jsxs("div",{className:"flex items-center gap-2 p-3 bg-blue-50 rounded-lg",children:[d.jsx(g,{className:"w-4 h-4 text-blue-600"}),d.jsxs("div",{children:[d.jsx("div",{className:"font-medium",children:a.name}),d.jsxs("div",{className:"text-sm text-muted-foreground",children:[a.total_points," puntos disponibles"]})]})]}),d.jsx("div",{className:"max-h-32 overflow-y-auto space-y-2",children:e.map(e=>d.jsxs("div",{className:"flex justify-between text-sm",children:[d.jsxs("span",{children:[e.quantity,"x ",e.products.name]}),d.jsx("span",{children:B(e.subtotal)})]},e.id))}),d.jsx(R,{}),d.jsxs("div",{className:"space-y-2",children:[d.jsxs("div",{className:"flex justify-between",children:[d.jsx("span",{children:"Subtotal:"}),d.jsx("span",{children:B(s.subtotal)})]}),parseFloat(m)>0&&d.jsxs("div",{className:"flex justify-between text-green-600",children:[d.jsx("span",{children:"Descuento:"}),d.jsxs("span",{children:["-",B(parseFloat(m))]})]}),d.jsx(R,{}),d.jsxs("div",{className:"flex justify-between font-bold text-lg",children:[d.jsx("span",{children:"Total a Pagar:"}),d.jsx("span",{children:B(S)})]})]})]})]}),d.jsxs(P,{children:[d.jsx(F,{children:d.jsx(_,{className:"text-lg",children:"Descuentos"})}),d.jsx(O,{className:"space-y-4",children:d.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[d.jsxs("div",{className:"space-y-2",children:[d.jsx(M,{htmlFor:"discount",children:"Descuento Manual"}),d.jsx(T,{id:"discount",type:"number",step:"0.01",min:"0",max:s.total,value:m,onChange:e=>x(e.target.value),placeholder:"0.00"})]}),d.jsxs("div",{className:"space-y-2",children:[d.jsx(M,{htmlFor:"coupon",children:"Código de Cupón"}),d.jsxs("div",{className:"flex gap-2",children:[d.jsx(T,{id:"coupon",value:u,onChange:e=>h(e.target.value),placeholder:"Código de cupón"}),d.jsx(I,{variant:"outline",onClick:()=>o(null,null,function*(){if(u.trim())try{const e=localStorage.getItem("token"),t=new URLSearchParams({client_id:(null==a?void 0:a.id)||"",purchase_amount:s.total.toString()}),l=yield fetch(`/api/clients/coupons/validate/${u}?${t}`,{headers:{Authorization:`Bearer ${e}`}});if(l.ok){const e=yield l.json();e.is_valid?(x(e.discount_amount.toString()),$({title:"Cupón válido",description:`Descuento aplicado: $${e.discount_amount.toFixed(2)}`})):$({title:"Cupón no válido",description:e.issues.join(", "),variant:"destructive"})}}catch(e){$({title:"Error",description:"Error al validar cupón",variant:"destructive"})}}),disabled:!u.trim(),children:"Aplicar"})]})]})]})})]}),d.jsxs(P,{children:[d.jsx(F,{children:d.jsx(_,{className:"text-lg",children:"Método de Pago"})}),d.jsxs(O,{className:"space-y-4",children:[d.jsx("div",{className:"grid grid-cols-3 gap-2",children:A.map(e=>{const s=e.icon;return d.jsxs(I,{variant:r===e.value?"default":"outline",onClick:()=>n(e.value),className:"h-16 flex flex-col gap-1",children:[d.jsx(s,{className:"w-5 h-5"}),d.jsx("span",{className:"text-xs",children:e.label})]},e.value)})}),d.jsxs("div",{className:"space-y-2",children:[d.jsx(M,{htmlFor:"payment-amount",children:"Monto Recibido"}),d.jsx(T,{id:"payment-amount",type:"number",step:"0.01",min:"0",value:i,onChange:e=>c(e.target.value),placeholder:"0.00",className:"text-lg h-12"})]}),"efectivo"===r&&d.jsxs("div",{className:"space-y-2",children:[d.jsx(M,{children:"Montos Rápidos"}),d.jsx("div",{className:"grid grid-cols-4 gap-2",children:q.map(e=>d.jsx(I,{variant:"outline",size:"sm",onClick:()=>c(e.toString()),className:"text-xs",children:B(e)},e))})]}),C>0&&d.jsx("div",{className:"p-3 bg-green-50 rounded-lg",children:d.jsxs("div",{className:"flex justify-between items-center",children:[d.jsx("span",{className:"font-medium",children:"Cambio:"}),d.jsx("span",{className:"text-xl font-bold text-green-600",children:B(C)})]})}),d.jsxs("div",{className:"space-y-2",children:[d.jsx(M,{htmlFor:"notes",children:"Notas (Opcional)"}),d.jsx(X,{id:"notes",value:j,onChange:e=>f(e.target.value),placeholder:"Notas sobre la venta...",rows:2})]})]})]}),d.jsxs("div",{className:"flex gap-2",children:[d.jsx(I,{variant:"outline",onClick:l,disabled:v,children:"Cancelar"}),d.jsxs(I,{onClick:()=>o(null,null,function*(){if(!i||parseFloat(i)<=0)$({title:"Error",description:"Ingresa un monto de pago válido",variant:"destructive"});else if(parseFloat(i)<S)$({title:"Error",description:"El monto pagado es insuficiente",variant:"destructive"});else{w(!0);try{const e=localStorage.getItem("token"),s=yield fetch("/api/sales/checkout",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${e}`},body:JSON.stringify({client_id:(null==a?void 0:a.id)||null,payment_method:r,payment_amount:parseFloat(i),discount_amount:parseFloat(m)||0,coupon_code:u.trim()||null,notes:j.trim()||null})});if(s.ok){const e=yield s.json();t(e)}else{const e=yield s.json();$({title:"Error en el pago",description:e.error||"Error al procesar el pago",variant:"destructive"})}}catch(e){$({title:"Error",description:"Error al procesar el pago",variant:"destructive"})}finally{w(!1)}}}),disabled:v||parseFloat(i)<S,className:"flex-1",children:[v?d.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-white mr-2"}):d.jsx(p,{className:"w-4 h-4 mr-2"}),"Procesar Pago"]})]})]})},G=({selectedClient:e,onSelectClient:s,onClose:a})=>{const[t,l]=E.useState(""),[r,n]=E.useState([]),[m,x]=E.useState(!1),[u,p]=E.useState(!1),[j,f]=E.useState({name:"",phone:"",email:"",address:""}),{toast:v}=D();E.useEffect(()=>{t.length>=2?N():n([])},[t]);const N=()=>o(null,null,function*(){try{x(!0);const e=localStorage.getItem("token"),s=yield fetch(`/api/clients?search=${encodeURIComponent(t)}&limit=10`,{headers:{Authorization:`Bearer ${e}`}});if(s.ok){const e=yield s.json();n(e.clients)}}catch(e){v({title:"Error",description:"Error al buscar clientes",variant:"destructive"})}finally{x(!1)}});return d.jsxs("div",{className:"space-y-4",children:[e&&d.jsx(P,{className:"border-blue-200 bg-blue-50",children:d.jsx(O,{className:"p-4",children:d.jsxs("div",{className:"flex items-center justify-between",children:[d.jsxs("div",{className:"flex items-center gap-3",children:[d.jsx("div",{className:"w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center",children:d.jsx(g,{className:"w-5 h-5 text-blue-600"})}),d.jsxs("div",{children:[d.jsx("h3",{className:"font-semibold",children:e.name}),d.jsxs("div",{className:"text-sm text-muted-foreground",children:["Código: ",e.client_code]}),d.jsxs("div",{className:"flex items-center gap-2 mt-1",children:[d.jsxs(z,{variant:"secondary",className:"text-xs",children:[d.jsx(w,{className:"w-3 h-3 mr-1"}),e.total_points," puntos"]}),e.phone&&d.jsx("span",{className:"text-xs text-muted-foreground",children:e.phone})]})]})]}),d.jsx(I,{variant:"outline",size:"sm",onClick:()=>{s(null)},children:"Quitar"})]})})}),d.jsxs("div",{className:"space-y-4",children:[d.jsxs("div",{className:"relative",children:[d.jsx(C,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 w-4 h-4"}),d.jsx(T,{placeholder:"Buscar por nombre, teléfono o código...",value:t,onChange:e=>l(e.target.value),className:"pl-10",autoComplete:"off"})]}),d.jsxs("div",{className:"flex gap-2",children:[d.jsxs(I,{variant:"outline",onClick:()=>p(!0),className:"flex-1",children:[d.jsx(h,{className:"w-4 h-4 mr-2"}),"Nuevo Cliente"]}),d.jsx(I,{variant:"outline",onClick:a,children:"Continuar sin cliente"})]})]}),d.jsxs("div",{className:"space-y-2 max-h-64 overflow-y-auto",children:[m&&d.jsxs("div",{className:"text-center py-4",children:[d.jsx("div",{className:"animate-spin rounded-full h-6 w-6 border-b-2 border-blue-600 mx-auto"}),d.jsx("p",{className:"text-sm text-muted-foreground mt-2",children:"Buscando..."})]}),!m&&t.length>=2&&0===r.length&&d.jsxs("div",{className:"text-center py-4",children:[d.jsx(g,{className:"mx-auto h-8 w-8 text-gray-400"}),d.jsx("h3",{className:"mt-2 text-sm font-semibold text-gray-900",children:"No se encontraron clientes"}),d.jsx("p",{className:"mt-1 text-sm text-gray-500",children:"Intenta con otro término o crea un nuevo cliente"})]}),r.map(e=>d.jsx(P,{className:"hover:shadow-md transition-shadow cursor-pointer",onClick:()=>s(e),children:d.jsx(O,{className:"p-4",children:d.jsx("div",{className:"flex items-center justify-between",children:d.jsxs("div",{className:"flex items-center gap-3 min-w-0 flex-1",children:[d.jsx("div",{className:"w-8 h-8 bg-gray-100 rounded-full flex items-center justify-center flex-shrink-0",children:d.jsx(g,{className:"w-4 h-4 text-gray-600"})}),d.jsxs("div",{className:"min-w-0 flex-1",children:[d.jsx("h4",{className:"font-medium truncate",children:e.name}),d.jsxs("div",{className:"flex items-center gap-2 mt-1",children:[e.phone&&d.jsxs("div",{className:"flex items-center text-xs text-muted-foreground",children:[d.jsx(k,{className:"w-3 h-3 mr-1"}),e.phone]}),e.email&&d.jsxs("div",{className:"flex items-center text-xs text-muted-foreground",children:[d.jsx(S,{className:"w-3 h-3 mr-1"}),e.email]})]}),d.jsxs("div",{className:"flex items-center gap-2 mt-1",children:[d.jsxs(z,{variant:"secondary",className:"text-xs",children:[e.total_points," puntos"]}),d.jsxs("span",{className:"text-xs text-muted-foreground",children:["Código: ",e.client_code]})]})]})]})})})},e.id))]}),d.jsx($,{open:u,onOpenChange:p,children:d.jsxs(B,{className:"max-w-md",children:[d.jsx(A,{children:d.jsx(q,{children:"Registrar Nuevo Cliente"})}),d.jsxs("div",{className:"space-y-4",children:[d.jsxs("div",{className:"space-y-2",children:[d.jsxs(M,{htmlFor:"name",children:["Nombre ",d.jsx("span",{className:"text-red-500",children:"*"})]}),d.jsx(T,{id:"name",value:j.name,onChange:e=>f(s=>c(i({},s),{name:e.target.value})),placeholder:"Nombre completo",required:!0})]}),d.jsxs("div",{className:"space-y-2",children:[d.jsx(M,{htmlFor:"phone",children:"Teléfono"}),d.jsx(T,{id:"phone",value:j.phone,onChange:e=>f(s=>c(i({},s),{phone:e.target.value})),placeholder:"Número de teléfono"})]}),d.jsxs("div",{className:"space-y-2",children:[d.jsx(M,{htmlFor:"email",children:"Email"}),d.jsx(T,{id:"email",type:"email",value:j.email,onChange:e=>f(s=>c(i({},s),{email:e.target.value})),placeholder:"Correo electrónico"})]}),d.jsxs("div",{className:"space-y-2",children:[d.jsx(M,{htmlFor:"address",children:"Dirección"}),d.jsx(T,{id:"address",value:j.address,onChange:e=>f(s=>c(i({},s),{address:e.target.value})),placeholder:"Dirección"})]}),d.jsxs("div",{className:"flex justify-end gap-2 pt-4",children:[d.jsx(I,{type:"button",variant:"outline",onClick:()=>p(!1),children:"Cancelar"}),d.jsx(I,{onClick:()=>o(null,null,function*(){if(j.name.trim())try{const e=localStorage.getItem("token"),a=yield fetch("/api/clients",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${e}`},body:JSON.stringify(j)});if(a.ok){const e=yield a.json();v({title:"Cliente creado",description:"El cliente se registró exitosamente"}),s(e.client),p(!1),f({name:"",phone:"",email:"",address:""})}else{const e=yield a.json();v({title:"Error",description:e.error||"Error al crear cliente",variant:"destructive"})}}catch(e){v({title:"Error",description:"Error al crear cliente",variant:"destructive"})}else v({title:"Error",description:"El nombre del cliente es requerido",variant:"destructive"})}),children:"Registrar Cliente"})]})]})]})})]})},W=()=>{const[e,s]=E.useState([]),[a,t]=E.useState(null),[l,r]=E.useState(""),[n,i]=E.useState([]),[c,m]=E.useState(!1),[x,u]=E.useState(!1),[h,p]=E.useState(!1),[j,f]=E.useState({total_items:0,subtotal:0,tax:0,total:0}),[N,y]=E.useState(!1),b=E.useRef(null),{toast:w}=D();E.useEffect(()=>{k(),b.current&&b.current.focus()},[]),E.useEffect(()=>{l?S():i([])},[l]);const k=()=>o(null,null,function*(){try{const e=localStorage.getItem("token"),a=yield fetch("/api/sales/cart/current",{headers:{Authorization:`Bearer ${e}`}});if(a.ok){const e=yield a.json();s(e.cart.items),f(e.cart.summary)}}catch(e){}}),S=()=>o(null,null,function*(){try{const e=localStorage.getItem("token"),s=new URLSearchParams({search:l,limit:"10",in_stock:"true"}),a=yield fetch(`/api/products?${s}`,{headers:{Authorization:`Bearer ${e}`}});if(a.ok){const e=yield a.json();i(e.products)}}catch(e){}}),F=(e,s=1)=>o(null,null,function*(){try{const a=localStorage.getItem("token"),t=yield fetch("/api/sales/cart/add-item",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${a}`},body:JSON.stringify({product_id:e,quantity:s})});if(t.ok)yield k(),r(""),i([]),b.current&&b.current.focus(),w({title:"Producto agregado",description:"El producto se agregó al carrito"});else{const e=yield t.json();w({title:"Error",description:e.error||"Error al agregar producto",variant:"destructive"})}}catch(a){w({title:"Error",description:"Error al agregar producto al carrito",variant:"destructive"})}}),_=()=>{0!==e.length?u(!0):w({title:"Carrito vacío",description:"Agrega productos antes de proceder al pago",variant:"destructive"})};return d.jsxs("div",{className:"container mx-auto py-4 h-screen flex flex-col",onKeyDown:e=>{"F1"===e.key&&(e.preventDefault(),m(!0)),"F2"===e.key&&(e.preventDefault(),p(!0)),"F3"===e.key&&(e.preventDefault(),_()),"Escape"===e.key&&(r(""),i([]),b.current&&b.current.focus())},tabIndex:0,children:[d.jsxs("div",{className:"flex items-center justify-between mb-4",children:[d.jsxs("div",{children:[d.jsx("h1",{className:"text-2xl font-bold",children:"Punto de Venta"}),d.jsx("p",{className:"text-sm text-muted-foreground",children:"Presiona F1 para scanner, F2 para cliente, F3 para pagar"})]}),d.jsxs("div",{className:"flex items-center gap-2",children:[a&&d.jsxs(z,{variant:"secondary",className:"px-3 py-1",children:[d.jsx(g,{className:"w-3 h-3 mr-1"}),a.name," (",a.total_points," pts)"]}),d.jsxs(I,{variant:"outline",size:"sm",onClick:()=>p(!0),children:[d.jsx(g,{className:"w-4 h-4 mr-1"}),"Cliente (F2)"]}),d.jsxs(I,{variant:"outline",size:"sm",onClick:()=>m(!0),children:[d.jsx(v,{className:"w-4 h-4 mr-1"}),"Scanner (F1)"]})]})]}),d.jsxs("div",{className:"flex-1 grid grid-cols-1 lg:grid-cols-3 gap-4 min-h-0",children:[d.jsxs("div",{className:"lg:col-span-2 flex flex-col min-h-0",children:[d.jsx(P,{className:"mb-4",children:d.jsx(O,{className:"p-4",children:d.jsxs("div",{className:"relative",children:[d.jsx(C,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 w-4 h-4"}),d.jsx(T,{ref:b,placeholder:"Buscar productos por nombre, SKU o código...",value:l,onChange:e=>r(e.target.value),className:"pl-10 text-lg h-12",autoComplete:"off"})]})})}),d.jsx("div",{className:"flex-1 overflow-y-auto",children:n.length>0?d.jsx("div",{className:"grid gap-2 md:grid-cols-2",children:n.map(e=>{return d.jsx(P,{className:"hover:shadow-md transition-shadow cursor-pointer",onClick:()=>F(e.id),children:d.jsxs(O,{className:"p-4",children:[d.jsxs("div",{className:"flex justify-between items-start mb-2",children:[d.jsxs("div",{className:"min-w-0 flex-1",children:[d.jsx("h3",{className:"font-semibold truncate",children:e.name}),d.jsx("p",{className:"text-sm text-muted-foreground",children:e.categories.name})]}),d.jsxs("div",{className:"text-right ml-2",children:[d.jsx("div",{className:"font-bold text-lg",children:(s=e.price,new Intl.NumberFormat("es-MX",{style:"currency",currency:"MXN"}).format(s))}),d.jsxs("div",{className:"text-xs text-muted-foreground",children:["Stock: ",e.stock_quantity," ",e.unit]})]})]}),e.sku&&d.jsxs("div",{className:"text-xs text-muted-foreground",children:["SKU: ",e.sku]}),d.jsx(z,{variant:e.stock_quantity>0?"default":"destructive",className:"text-xs mt-2",children:e.stock_quantity>0?"Disponible":"Sin stock"})]})},e.id);var s})}):l?d.jsxs("div",{className:"text-center py-12",children:[d.jsx(C,{className:"mx-auto h-12 w-12 text-gray-400"}),d.jsx("h3",{className:"mt-2 text-sm font-semibold text-gray-900",children:"No se encontraron productos"}),d.jsx("p",{className:"mt-1 text-sm text-gray-500",children:"Intenta con otro término de búsqueda"})]}):d.jsxs("div",{className:"text-center py-12",children:[d.jsx(v,{className:"mx-auto h-12 w-12 text-gray-400"}),d.jsx("h3",{className:"mt-2 text-sm font-semibold text-gray-900",children:"Busca o escanea productos"}),d.jsx("p",{className:"mt-1 text-sm text-gray-500",children:"Escribe el nombre del producto o usa el scanner"})]})})]}),d.jsx("div",{className:"flex flex-col min-h-0",children:d.jsx(J,{items:e,summary:j,onUpdateQuantity:(e,s)=>o(null,null,function*(){try{const a=localStorage.getItem("token"),t=yield fetch(`/api/sales/cart/items/${e}`,{method:"PATCH",headers:{"Content-Type":"application/json",Authorization:`Bearer ${a}`},body:JSON.stringify({quantity:s})});if(t.ok)yield k();else{const e=yield t.json();w({title:"Error",description:e.error||"Error al actualizar cantidad",variant:"destructive"})}}catch(a){}}),onRemoveItem:e=>o(null,null,function*(){try{const s=localStorage.getItem("token");(yield fetch(`/api/sales/cart/items/${e}`,{method:"DELETE",headers:{Authorization:`Bearer ${s}`}})).ok&&(yield k(),w({title:"Producto eliminado",description:"El producto se eliminó del carrito"}))}catch(s){}}),onClearCart:()=>o(null,null,function*(){if(confirm("¿Estás seguro de limpiar todo el carrito?"))try{const e=localStorage.getItem("token");(yield fetch("/api/sales/cart/clear",{method:"DELETE",headers:{Authorization:`Bearer ${e}`}})).ok&&(yield k(),w({title:"Carrito limpiado",description:"Todos los productos fueron eliminados"}))}catch(e){}}),onCheckout:_})})]}),d.jsx($,{open:c,onOpenChange:m,children:d.jsxs(B,{className:"max-w-md",children:[d.jsx(A,{children:d.jsx(q,{children:"Escáner de Código de Barras"})}),d.jsx(H,{onScan:e=>o(null,null,function*(){try{y(!0);const s=localStorage.getItem("token"),a=yield fetch("/api/sales/cart/scan",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${s}`},body:JSON.stringify({barcode:e})});if(a.ok){const e=yield a.json();yield F(e.product.id,1),m(!1)}else{const e=yield a.json();w({title:"Producto no encontrado",description:e.error||"No se encontró un producto con ese código",variant:"destructive"})}}catch(s){w({title:"Error",description:"Error al escanear producto",variant:"destructive"})}finally{y(!1)}}),onClose:()=>m(!1),loading:N})]})}),d.jsx($,{open:h,onOpenChange:p,children:d.jsxs(B,{className:"max-w-2xl max-h-[80vh] overflow-y-auto",children:[d.jsx(A,{children:d.jsx(q,{children:"Seleccionar Cliente"})}),d.jsx(G,{selectedClient:a,onSelectClient:e=>{t(e),p(!1)},onClose:()=>p(!1)})]})}),d.jsx($,{open:x,onOpenChange:u,children:d.jsxs(B,{className:"max-w-2xl max-h-[90vh] overflow-y-auto",children:[d.jsx(A,{children:d.jsx(q,{children:"Procesar Pago"})}),d.jsx(Q,{cartItems:e,cartSummary:j,selectedClient:a,onPaymentComplete:e=>{u(!1),t(null),k(),w({title:"¡Venta completada!",description:`Venta #${e.sale.sale_number} procesada exitosamente`}),confirm("¿Deseas imprimir el ticket?")&&window.open(`/api/sales/receipt/${e.sale.id}?format=html`,"_blank")},onCancel:()=>u(!1)})]})})]})};export{W as default};
